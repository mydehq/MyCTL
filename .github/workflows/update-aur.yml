name: Update AUR Package
run-name: Update AUR to ${{ github.event.release.tag_name }}

on:
  release:
    types:
      - published
      - prereleased

  workflow_dispatch:

concurrency:
  group: update-aur
  cancel-in-progress: true

jobs:
  aur-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Debug Release Type
        run: |
          echo "Event Name: ${{ github.event_name }}"
          echo "Release Action (Type): ${{ github.event.action }}"
          echo "Is Prerelease: ${{ github.event.release.prerelease }}"

      - name: Get Version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            # Strip the 'v' prefix from the tag
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV
            echo "PKGREL=1" >> $GITHUB_ENV
            echo "IS_MANUAL=false" >> $GITHUB_ENV
          else
             # For manual trigger, read from PKGBUILD
             echo "Fetching version from PKGBUILD..."
             PKGVER=$(grep "^pkgver=" PKGBUILD | cut -d'=' -f2)
             PKGREL=$(grep "^pkgrel=" PKGBUILD | cut -d'=' -f2)
             echo "VERSION=$PKGVER" >> $GITHUB_ENV
             echo "PKGREL=$PKGREL" >> $GITHUB_ENV
             echo "IS_MANUAL=true" >> $GITHUB_ENV
          fi

      - name: Check AUR Version
        id: check_aur_version
        run: |
          # Get current AUR package version
          # We want the full version string (e.g. 1.3.0-1) for comparison
          AUR_FULL_VERSION=$(curl -s "https://aur.archlinux.org/rpc/v5/info/myctl" | \
            jq -r '.results[0].Version // empty')
          
          REPO_FULL_VERSION="${{ env.VERSION }}-${{ env.PKGREL }}"

          echo "Repo version: $REPO_FULL_VERSION"
          echo "AUR version: $AUR_FULL_VERSION"

          # Compare versions
          if [ -n "$AUR_FULL_VERSION" ] && [ "$AUR_FULL_VERSION" != "null" ]; then
            if [ "$AUR_FULL_VERSION" == "$REPO_FULL_VERSION" ]; then
              echo "AUR version is already at $REPO_FULL_VERSION. Skipping update."
              echo "SKIP_UPDATE=true" >> $GITHUB_ENV
            elif echo -e "${AUR_FULL_VERSION}\n${REPO_FULL_VERSION}" | sort -V -C 2>/dev/null; then
              echo "AUR version ($AUR_FULL_VERSION) is older than repo version ($REPO_FULL_VERSION). Proceeding with update."
              echo "SKIP_UPDATE=false" >> $GITHUB_ENV
            else
              echo "AUR version ($AUR_FULL_VERSION) is newer than repo version ($REPO_FULL_VERSION). Skipping update."
              echo "SKIP_UPDATE=true" >> $GITHUB_ENV
            fi
          else
            echo "Could not fetch AUR version or package doesn't exist, proceeding with update"
            echo "SKIP_UPDATE=false" >> $GITHUB_ENV
          fi

      - name: Update PKGBUILD and Checksums
        if: env.SKIP_UPDATE == 'false'
        run: |
          docker run --rm -v "$PWD:/src" -w /src archlinux:base-devel sh -c '
            # 1. Install utils
            pacman -Sy --noconfirm pacman-contrib git

            # 2. Update pkgver/pkgrel in PKGBUILD only if released
            if [ "${{ env.IS_MANUAL }}" == "false" ]; then
               echo "Updating PKGBUILD version to ${{ env.VERSION }} and resetting pkgrel..."
               sed -i "s/^pkgver=.*$/pkgver=${{ env.VERSION }}/" PKGBUILD
               sed -i "s/^pkgrel=.*$/pkgrel=1/" PKGBUILD
            else
               echo "Manual trigger detected. Keeping PKGBUILD version as is."
            fi

            # 3. Update Checksums
            # This will download the tarball (if validating remote source)
            # OR just update based on local file if we changed logic. 
            # Standard updpkgsums downloads source.
            updpkgsums

            # 4. Generate .SRCINFO
            makepkg --printsrcinfo > .SRCINFO

            # 5. Fix Permissions
            chown -R 1001:121 .
          '

      - name: Publish to AUR
        if: env.SKIP_UPDATE == 'false'
        uses: KSXGitHub/github-actions-deploy-aur@v2.2.5
        with:
          pkgname: myctl
          pkgbuild: ./PKGBUILD
          commit_username: ${{ secrets.AUR_USERNAME }}
          commit_email: ${{ secrets.AUR_EMAIL }}
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Update to ${{ env.VERSION }}-${{ env.PKGREL }}"
          ssh_keyscan_types: rsa,ecdsa,ed25519
