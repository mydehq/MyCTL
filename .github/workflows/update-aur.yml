name: Update AUR Package
run-name: Update AUR to ${{ github.event.release.tag_name }}

on:
  release:
    types:
      - published
      - prereleased

  workflow_dispatch:

concurrency:
  group: update-aur
  cancel-in-progress: true

jobs:
  aur-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Debug Release Type
        run: |
          echo "Event Name: ${{ github.event_name }}"
          echo "Release Action (Type): ${{ github.event.action }}"
          echo "Is Prerelease: ${{ github.event.release.prerelease }}"

      - name: Get Version from Tag
        id: get_version
        run: |
          # Strip the 'v' prefix from the tag
          echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV

      - name: Check AUR Version
        id: check_aur_version
        run: |
          # Get current AUR package version
          AUR_VERSION=$(curl -s "https://aur.archlinux.org/rpc/v5/info/myctl" | \
            jq -r '.results[0].Version // empty' | \
            sed 's/-[0-9]*$//')

          echo "Upstream version: ${{ env.VERSION }}"
          echo "AUR version: $AUR_VERSION"

          # Compare versions
          if [ -n "$AUR_VERSION" ] && [ "$AUR_VERSION" != "null" ]; then
            if echo -e "${AUR_VERSION}\n${{ env.VERSION }}" | sort -V -C 2>/dev/null; then
              echo "AUR version is already up-to-date or newer than repo version"
              echo "SKIP_UPDATE=true" >> $GITHUB_ENV
            else
              echo "AUR version is older than repo version, proceeding with update"
              echo "SKIP_UPDATE=false" >> $GITHUB_ENV
            fi
          else
            echo "Could not fetch AUR version or package doesn't exist, proceeding with update"
            echo "SKIP_UPDATE=false" >> $GITHUB_ENV
          fi

      - name: Update PKGBUILD and Checksums
        if: env.SKIP_UPDATE == 'false'
        run: |
          docker run --rm -v "$PWD:/src" -w /src archlinux:base-devel sh -c '
            # 1. Install utils
            pacman -Sy --noconfirm pacman-contrib git

            # 2. Update pkgver in PKGBUILD
            # We use double quotes inside sed so the variable expands,
            # but single quotes around sh -c to keep it safe.
            sed -i "s/^pkgver=.*$/pkgver=${{ env.VERSION }}/" PKGBUILD

            # 3. Reset pkgrel to 1
            sed -i "s/^pkgrel=.*$/pkgrel=1/" PKGBUILD

            # 4. Update Checksums
            # This will download the tarball you just attached to the Release
            # and calculate the SHA256 automatically.
            updpkgsums

            # 5. Generate .SRCINFO
            makepkg --printsrcinfo > .SRCINFO

            # 6. Fix Permissions
            # Docker creates files as root. We must give them back to the GitHub Runner (1001:121)
            chown -R 1001:121 .
          '

      - name: Publish to AUR
        if: env.SKIP_UPDATE == 'false'
        uses: KSXGitHub/github-actions-deploy-aur@v2.2.5
        with:
          pkgname: myctl
          pkgbuild: ./PKGBUILD
          commit_username: ${{ secrets.AUR_USERNAME }}
          commit_email: ${{ secrets.AUR_EMAIL }}
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Update to ${{ env.VERSION }}"
          ssh_keyscan_types: rsa,ecdsa,ed25519
