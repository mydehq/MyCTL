#!/usr/bin/env bash
#   __  __        ____ _____ _
#  |  \/  |_   _ / ___|_   _| |
#  | |\/| | | | | |     | | | |
#  | |  | | |_| | |___  | | | |___
#  |_|  |_|\__, |\____| |_| |_____|
#          |___/
#
#  A powerful CLI to control your Linux Desktop


# ~/.config/myde - /etc/myde
# ~/.local/bin   - /usr/bin
# ~/.local/lib   - /usr/lib
# ~/.local/src   - /usr/src
# ~/.local/share - /usr/share


# ======================== Config ===========================

MYDE_DIR="$HOME/MyDE"
MYDE_CONF="${XDG_CONFIG_HOME:-$HOME/.config}/mydehq/myde.conf"
LIB_DIR="$HOME/.local/lib/myctl"
SRC_DIR="$HOME/.local/src/myctl"

LOG_MIN_LEVEL="info"
LOG_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/myde"
LOG_FILE="${LOG_DIR}/myctl.log"

MAX_VOLUME=153
MAX_MIC=$MAX_VOLUME

#========================== Main Logic =========================

THIS_PATH="$(realpath "${BASH_SOURCE[0]}")"

# Detect if this is a system-wide installation
if [[ "$THIS_PATH" == "/usr/bin/myctl" ]]; then
    LIB_DIR="/usr/lib/myctl"
    SRC_DIR="/usr/src/myctl"
fi

declare -x  LOG_MIN_LEVEL MAX_VOLUME MAX_MIC LOG_FILE
declare -rx MYDE_DIR MYDE_CONF \
            THIS_PATH LIB_DIR SRC_DIR LOG_DIR

# Dictionaries
declare -A cmd_map IMPORTED_LIBS

# Make Log directory, Log file
! [ -d "$LOG_DIR" ] && mkdir -p "$LOG_DIR"
! [ -f "$LOG_FILE" ] && touch "$LOG_FILE"

  # shellcheck source=/dev/null
{ source "$LIB_DIR"/_colors.sh && IMPORTED_LIBS[$(realpath "$LIB_DIR"/_colors.sh)]=1; } || {
    echo "FATAL: Failed to source colros"
    exit 1
}

  # shellcheck source=/dev/null
{ source "$LIB_DIR"/_utils.sh && IMPORTED_LIBS[$(realpath "$LIB_DIR"/_utils.sh)]=1; } || {
    echo "FATAL: Failed to source Utils"
    exit 1
}

[[ "$#" -eq 0 ]] && {
    self help
    exit 1
}


case "$1" in

    help|'-h'|--help)
        cmd_map=(
            [cmd]="myctl"
            [get]="Retrieve info about current system config."
            [pkg]="Package Management utils"
            [reload]="Reload MyDE configuration"
            [set]="Set configuration options (not yet implemented)"
            [show]="Show various utility dialougs"
        )
        help-menu
        ;;

    # ==================== Get ====================
    get)
        shift # $1 = arg2
        case "$1" in
            help)
                cmd_map=(
                    [cmd]="get"
                    [desktop-file]="Get desktop file path of an application"
                    [desktop-filename]="Get desktop file name of an application"
                    [distro]="Get distro name/info"
                    [conf]="Get value of given key in MyDE conf file"
                    [mic]="Get microphone/source volume"
                    [snip]="Get screenshot of selection/window/desktop"
                    [theme]="Get current theme of MyDE or specific components"
                    [volume]="Get speaker/sink volume"
                )
                help-menu
                ;;
            desktop-file)
                shift
                import-lib "get-desktop-file"
                get-desktop-file "$1"
                ;;
            desktop-filename)
                shift
                import-lib "get-desktop-file"
                get-desktop-file -n "$1"
                ;;
            distro)
                shift
                import-lib "pkg-utils"
                cmd_map[cmd]="get distro"
                case "$1" in
                    help)
                        cmd_map=(
                            [name]="get current distro name. (default)"
                            [base]="get current distro base."
                        )
                        help-menu
                        ;;
                    ""|name)
                        get-distro
                        ;;
                    base)
                        shift
                        cmd_map[cmd]="get distro base"
                        case "$1" in
                            help)
                                cmd_map[cmd]="get distro base"
                                cmd_map[\"\"]="Get base distro of current distro"
                                cmd_map[\<distro_name\>]="Get base distro of specified distro"
                                help-menu
                                ;;
                            "")
                                get-distro-base
                                ;;
                            *)
                                get-distro-base "$1"
                        esac
                        ;;
                    *)
                        invalid-cmd "$1" && self "${cmd_map[cmd]}" help
                        exit 1
                        ;;
                esac
                ;;
            conf)
                shift
                cmd_map[cmd]="get conf"
                read-conf "$1"
                ;;
            cursor)
                shift
                cmd_map[cmd]="get cursor"
                case "$1" in
                    help)
                        cmd_map=(
                            [name]="get current cursor theme name."
                            [size]="get current cursor size."
                        )
                        help-menu
                        ;;
                    theme)
                        import-lib "gtk-utils"
                        get-gtk-cursor-theme
                        ;;
                    size)
                        import-lib "gtk-utils"
                        get-gtk-cursor-size
                        ;;
                    ""|*)
                        invalid-cmd "$1" && self get cursor help
                        exit 1
                        ;;
                esac
                ;;
            mic)
                shift
                cmd_map[cmd]="get mic"
                case "$1" in
                    help)
                        cmd_map=(
                            [usage]="myctl get mic"
                        )
                        help-menu
                        ;;
                    mute)
                        import-lib "audio-utils"
                        get-mute -m
                        ;;
                    "")
                        import-lib "audio-utils"
                        get-volume -m
                        ;;
                    *)
                        invalid-cmd "$1" && self get mic help
                        exit 1
                        ;;
                esac
                ;;
            snip)
                cmd_map[cmd]="get snip"
                cmd_map[usage]="myctl get snip [area|screen|active]"
                shift
                case $1 in
                    help)
                        cmd_map=(
                            [area]="Take Screenshot of area (default)"
                            [active]="Take Screenshot of active window"
                            [screen]="Take Screenshot of screen"
                        )
                        help-menu
                        ;;
                    active|screen)
                        cmd_map[cmd]="get snip $1"
                        cmd_map[usage]="myctl get snip $1"
                        import-lib "snipping"
                        snip "$1"
                        ;;
                    ""|area)
                        cmd_map[cmd]="get snip area"
                        import-lib "snipping"
                        snip area
                        ;;
                    *)
                        invalid-cmd "$1" && self get snip help
                        exit 1
                        ;;
                esac
                ;;
            theme)
                shift
                cmd_map=(
                    [cmd]="get theme"
                    [gtk]="get current gtk color theme."
                    [qt]="get current qt color theme. (not yet implemented)"
                    [rofi]="get current rofi color theme."
                )
                case "$1" in
                    help)
                        help-menu
                        ;;
                    rofi)
                        import-lib "rofi-utils"
                        get-rofi-theme
                        ;;
                    gtk)
                        import-lib "gtk-utils"
                        get-gtk-theme
                        ;;
                    qt|kde)
                        log.nyi   #TODO
                        ;;
                    ""|*)
                        invalid-cmd "$1" && self get theme help
                        exit 1
                        ;;
                esac
                ;;
            volume)
                shift
                case "$1" in
                    help)
                        cmd_map=(
                            [cmd]="get volume"
                            [usage]="myctl get volume"
                        )
                        help-menu
                        ;;
                    mute)
                        import-lib "audio-utils"
                        get-mute
                        ;;
                    "")
                        import-lib "audio-utils"
                        get-volume
                        ;;
                    *)
                        invalid-cmd "$1" && self get volume help
                        exit 1
                        ;;
                esac
                ;;
            ""|*)
                invalid-cmd "$1" && self get help
                exit 1
                ;;
        esac
        ;;

    #======================= pkg ====================
    pkg)
        cmd_map[cmd]="pkg"
        shift
        case "$1" in
            help)
                cmd_map=(
                    [add]="Install a package(s)"
                    [rm]="Remove a package(s)"
                    [ignore]="Ignore a package(s) (ignore while updating)"
                    [search]="Search for a package"
                    [sync]="Sync all packages with db"
                    [update]="Update package(s)"
                )
                help-menu
                ;;
            "")
                invalid-cmd && self pkg help
                exit 1
                ;;
            add)
               import-lib "pkg-utils"
               shift
               ;;
            rm)
               shift
               ;;
            ignore)
               shift
               ;;
            search)
               shift
               ;;
            sync)
               shift
               ;;
            update)
               shift
               ;;
            *)
                invalid-cmd "$1" && self help
                exit 1
                ;;
        esac
        ;;

    # ==================== reload ====================
    reload)
        shift
        case "$1" in
            help)
                cmd_map=(
                    [cmd]="reload"
                )
                help-menu
                ;;
            "")
                hyprctl reload > /dev/null
                log.success "myde configuration reloaded."
                ;;
            *)
                invalid-cmd "$1" && self help
                exit 1
                ;;
        esac
        ;;

    # ==================== set ====================
    set)
        shift
        case "$1" in
            help)
                cmd_map=(
                    [cmd]="set"
                    [mic]="set microphone/source volume or mute"
                    [terminal]="Set Default Terminal"
                    [theme]="set theme for entire myde or specific components."
                    [volume]="set speaker/sink volume or mute"
                )
                help-menu
                ;;
            mic)
                shift
                case "$1" in
                    help)
                        cmd_map=(
                            [cmd]="set mic"
                            [usage]="myctl set mic [+|-]<level>"
                        )
                        help-menu
                        ;;
                    mute)
                      import-lib "audio-utils"
                      set-mute
                      ;;
                    unmute)
                      import-lib "audio-utils"
                      set-mute -m -u
                      ;;
                    toggle)
                      import-lib "audio-utils"
                      set-mute -m -t
                      ;;
                    "")
                        self set mic help
                        exit 1
                        ;;
                    *)
                        import-lib "audio-utils"
                        set-volume -m "$1"
                        ;;
                esac
                ;;
            terminal)
                import-lib "get-desktop-file"
                [ -n "$TERMINAL" ] || log.fatal "Terminal not set"
                term_desktop="$(get-desktop-file -n "$TERMINAL")"
                handlr set x-scheme-handler/terminal "$term_desktop" &> /dev/null
                kwriteconfig6 --file "$HOME/.config/kdeglobals" --group General --key TerminalService "$term_desktop"
                ;;
            theme)
                shift # $1 = arg3
                case "$1" in
                    help)
                        cmd_map=(
                            [cmd]="set theme"
                            [gtk]="set gtk color theme."
                            [rofi]="set rofi color theme."
                        )
                        help-menu
                        ;;
                    rofi)
                        shift
                        import-lib "rofi-utils"
                        set-rofi-theme "$1"
                        ;;
                    gtk)
                        shift
                        import-lib "gtk-utils"
                        set-gtk-theme "$1"
                        ;;
                    ""|*)
                        invalid-cmd "$1" && self set theme help
                        exit 1
                        ;;
                esac
                ;;
            volume)
                shift
                case "$1" in
                    help)
                        cmd_map=(
                            [cmd]="set volume"
                            [usage]="myctl set volume [+|-]<level>"
                        )
                        help-menu
                        ;;
                    mute)
                      import-lib "audio-utils"
                      set-mute
                      ;;
                    unmute)
                      import-lib "audio-utils"
                      set-mute -u
                      ;;
                    toggle)
                      import-lib "audio-utils"
                      set-mute -t
                      ;;
                    "")
                      self set volume help
                      exit 1
                      ;;
                    *)
                      import-lib "audio-utils"
                      set-volume "$1"
                      ;;
                esac
                ;;
            ""|*)
                invalid-cmd "$1" && self set help
                exit 1
                ;;
        esac
        ;;

    # =================== setup ====================
    setup)
        shift
        cmd_map[cmd]="setup"
        case "$1" in
            help)
                cmd_map=(
                    [wob]="Setup wob osd background Server"
                )
                help-menu
                ;;
            wob-daemon)
                cmd_map[cmd]="setup wob"
                import-lib "wob-osd"
                start-wob-daemon
                ;;
            ""|*)
                invalid-cmd "$1" && self setup help
                exit 1
                ;;
        esac
        ;;

    # ==================== show ====================
    show)
        shift
        case "$1" in
            help)
                cmd_map=(
                    [cmd]="show"
                    [keybinds]="Show keybinds hint window."
                    [power-menu]="Show power menu window."
                    [wifi-menu]="Show wifi menu window."
                    [wobar]="Show wob osd bar"
                )
                help-menu
                ;;
            keybinds)
                import-lib "keybinds-menu"
                show-keybinds-menu
                ;;
            'power-menu')
                import-lib "power-menu"
                show-power-menu
                ;;
            tui)
                shift
                cmd_map=(
                    [cmd]="show tui"
                    [usage]="myctl show tui [-t <task>] [-T <terminal>] [-c <class>] [-e <exec>]"
                    [-c, --class]="Application class for the terminal window"
                    [-e, --exec]="Command to run"
                    [-t, --term]="Terminal emulator to use (default: $TERMINAL)"
                )
                import-lib "tui-app"
                open-tui "$@"
                ;;
            'wifi-menu')
                eval "$(self get conf wifi_menu)"
                ;;
            wobar)
                shift
                cmd_map=(
                    [cmd]="show wobar"
                    [usage]="myctl show wobar <level>"
                )
                case "$1" in
                    help)
                        help-menu
                        exit 0
                        ;;
                    "")
                        invalid-cmd && self show wobar help
                        exit 1
                        ;;
                    *)
                        import-lib "wob-osd"
                        show-wobar "$1"
                        ;;
                esac
                ;;
            ""|*)
                invalid-cmd "$1" && self show help
                exit 1
                ;;
        esac
        ;;

    # ==================== default ====================
    ""|*)
        invalid-cmd "$1" && self help
        exit 1
        ;;
esac
